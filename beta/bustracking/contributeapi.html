<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bus Services</title>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
  }

  h1 {
    margin-bottom: 20px;
  }

  label {
    display: block;
    margin-bottom: 5px;
  }

  input[type="text"] {
    width: 100%;
    padding: 8px;
    font-size: 16px;
    border-radius: 5px;
    border: 1px solid #ccc;
    box-sizing: border-box;
    margin-bottom: 20px;
  }

  .search-results {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #ccc;
    border-radius: 5px;
    padding: 10px;
    display: none; /* Initially hide the search results */
  }

  .search-result {
    margin-bottom: 5px;
    cursor: pointer;
  }

  .search-result:hover {
    background-color: #f0f0f0;
  }

  .disabled {
    background-color: #f0f0f0;
    pointer-events: none;
  }
</style>
</head>
<body>
<h1>Bus Services</h1>

<div class="bus-service-search">
  <label for="serviceSearchInput">Search Bus Service:</label>
  <input type="text" id="serviceSearchInput" placeholder="Enter bus service">

  <div class="search-results" id="serviceSearchResults"></div>
</div>

<div class="destination-search">
  <label for="destinationSearchInput">Select Destination:</label>
  <input type="text" id="destinationSearchInput" placeholder="Select destination" readonly class="disabled">

  <div class="search-results" id="destinationSearchResults"></div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const myHeaders = new Headers();
  myHeaders.append("AccountKey", "1wo2iVrSTjeP0HHhAwdwoQ==");

  const requestOptions = {
    method: "GET",
    headers: myHeaders,
    redirect: "follow"
  };

  const fetchBusStops = async () => {
    let allBusStops = [];
    let skip = 0;
    let keepFetching = true;

    while (keepFetching) {
      const response = await fetch(`https://sgbusspotters.up.railway.app/http://datamall2.mytransport.sg/ltaodataservice/BusStops/http://datamall2.mytransport.sg/ltaodataservice/BusStops?$skip=${skip}`, requestOptions);
      const data = await response.json();
      if (data.value.length > 0) {
        allBusStops = allBusStops.concat(data.value);
        skip += 500;
      } else {
        keepFetching = false;
      }
    }

    return allBusStops;
  };

  const fetchBusServices = async () => {
    let allBusServices = [];
    let skip = 0;
    let keepFetching = true;

    while (keepFetching) {
      const response = await fetch(`https://sgbusspotters.up.railway.app/http://datamall2.mytransport.sg/ltaodataservice/BusServices?$skip=${skip}`, requestOptions);
      const data = await response.json();
      if (data.value.length > 0) {
        allBusServices = allBusServices.concat(data.value);
        skip += 500;
      } else {
        keepFetching = false;
      }
    }

    return allBusServices;
  };

  const populateServiceSearchResults = async () => {
    const allBusServices = await fetchBusServices();
    const allBusStops = await fetchBusStops();

    const serviceSearchInput = document.getElementById('serviceSearchInput');
    const serviceSearchResults = document.getElementById('serviceSearchResults');
    const destinationSearchInput = document.getElementById('destinationSearchInput');
    const destinationSearch = document.querySelector('.destination-search');
    
    serviceSearchInput.addEventListener('input', async (event) => {
      const searchText = event.target.value.toLowerCase().trim();
      const filteredResults = allBusServices.filter(service => {
        return service.ServiceNo.toLowerCase().includes(searchText);
      });

      // Clear previous results
      serviceSearchResults.innerHTML = '';

      if (searchText.length > 0) {
        // Display search results box
        serviceSearchResults.style.display = 'block';
        // Create a set to store unique service numbers
        const uniqueServices = new Set();
        // Display filtered results
        filteredResults.forEach(result => {
          // Check if service number is already added to the set
          if (!uniqueServices.has(result.ServiceNo)) {
            uniqueServices.add(result.ServiceNo);
            const resultItem = document.createElement('div');
            resultItem.classList.add('search-result');
            resultItem.textContent = result.ServiceNo;
            resultItem.addEventListener('click', async () => {
              // Populate search input with selected result
              serviceSearchInput.value = result.ServiceNo;
              // Hide search results box after selection
              serviceSearchResults.style.display = 'none';
              // Populate destination search input with corresponding destination codes
              const destinationCodes = allBusServices.filter(service => service.ServiceNo === result.ServiceNo)
                                                      .map(service => service.DestinationCode);
              if (destinationCodes.length === 1) {
                // Auto-select if only one destination code
                const destination = await getDestinationDescription(destinationCodes[0], allBusStops);
                destinationSearchInput.value = destination;
                destinationSearchInput.removeAttribute('readonly');
                destinationSearchInput.classList.remove('disabled');
              } else {
                // Allow user to choose if multiple destination codes
                destinationSearchInput.placeholder = "Select destination";
                destinationSearchInput.removeAttribute('readonly');
                destinationSearchInput.classList.remove('disabled');
                populateDestinationSearchResults(destinationCodes, allBusStops);
                destinationSearch.style.display = 'block';
              }
            });
            serviceSearchResults.appendChild(resultItem);
          }
        });
      } else {
        // Hide search results box if search input is empty
        serviceSearchResults.style.display = 'none';
        destinationSearchInput.setAttribute('readonly', 'readonly');
        destinationSearchInput.classList.add('disabled');
        destinationSearchInput.value = '';
        document.getElementById('destinationSearchResults').style.display = 'none';
      }
    });
  };

  const populateDestinationSearchResults = async (destinationCodes, allBusStops) => {
    const destinationSearchResults = document.getElementById('destinationSearchResults');
    destinationSearchResults.innerHTML = '';

    // Display destination options for user to choose
    for (const destinationCode of destinationCodes) {
      const destination = await getDestinationDescription(destinationCode, allBusStops);
      const destinationItem = document.createElement('div');
      destinationItem.classList.add('search-result');
      destinationItem.textContent = destination;
      destinationItem.addEventListener('click', () => {
        // Populate destination search input with selected destination code
        document.getElementById('destinationSearchInput').value = destination;
        // Hide destination search results box after selection
        destinationSearchResults.style.display = 'none';
      });
      destinationSearchResults.appendChild(destinationItem);
    }

    // Display destination search results box
    destinationSearchResults.style.display = 'block';
  };

  const getDestinationDescription = async (destinationCode, allBusStops) => {
    const destination = allBusStops.find(stop => stop.BusStopCode === destinationCode);
    return destination ? `${destination.BusStopCode} ${destination.Description}` : destinationCode;
  };

  populateServiceSearchResults();
});
</script>
</body>
</html>
