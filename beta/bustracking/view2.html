<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Bus Sightings</title>
</head>
<body>
    <h2>View Bus Sightings</h2>
    <table>
        <thead>
            <tr>
                <th>Bus Plate</th>
                <th>Service (it is on)</th>
                <th>Last Updated</th>
            </tr>
        </thead>
        <tbody id="bus-sightings">
            <!-- Bus sightings will be dynamically added here -->
        </tbody>
    </table>

    <script src="https://www.gstatic.com/firebasejs/9.6.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.2/firebase-firestore.js"></script>
    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID",
            measurementId: "YOUR_MEASUREMENT_ID"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const sightingsList = document.getElementById('bus-sightings');

        // Function to render bus sighting
        function renderSighting(data) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${data.busPlate}</td>
                <td>${data.service}</td>
                <td>${data.timestamp.toDate().toLocaleDateString()}</td>
            `;
            sightingsList.appendChild(tr);

            // Add event listener to the row to show all timestamps on click
            tr.addEventListener('click', () => {
                showAllTimestamps(data.busPlate);
            });
        }

        // Function to show all timestamps for a specific bus plate
        function showAllTimestamps(busPlate) {
            const timestampRef = db.collection('bus-sightings')
                                    .where('busPlate', '==', busPlate)
                                    .orderBy('timestamp', 'desc');

            timestampRef.get().then((querySnapshot) => {
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    alert(`Bus Plate: ${data.busPlate}\nTimestamp: ${data.timestamp.toDate().toLocaleString()}`);
                });
            }).catch((error) => {
                console.error("Error getting documents: ", error);
            });
        }

        // Preload the table with bus plates and "NIL" for service and last updated
        ['SG5999Z', 'SG4012C', 'SG4013A'].forEach(busPlate => {
            renderSighting({ busPlate, service: 'NIL', timestamp: new Date() });
        });

        // Real-time listener for bus sightings
        db.collection('bus-sightings').onSnapshot(snapshot => {
            snapshot.docChanges().forEach(change => {
                const data = change.doc.data();
                if (change.type === 'added') {
                    renderSighting(data);
                }
            });
        });
    </script>
</body>
</html>
