<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pinyin Spelling Practice 拼音听写复习</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap');

        body {
            font-family: "Inter", sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
        }
        h1 {
            margin-top: 20px;
        }
        #inputBoxContainer {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }
        #inputBox {
            width: 60%;
            padding: 10px;
            font-size: 18px;
            font-family: "Inter";
            text-align: center;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            font-family: "Inter";
            margin: 10px;
            border-radius: 20px;
        }
        #pinyinDisplay {
            font-size: 32px;
            margin: 20px 0;
            color: #333;
        }
        #navigationButtons {
            margin-top: 20px;
        }
        #soundIcon {
            font-size: 40px;
            cursor: pointer;
            margin-top: 10px;
            color: #007bff; /* Change color as desired */
            display: none; /* Initially hidden */
        }
        #accountSection {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
        }
        #accountIcon {
            font-size: 24px;
            margin-right: 5px;
        }
        #loginText {
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    
    <div id="accountSection">
        <span id="accountIcon" class="material-icons">account_circle</span>
        <span id="loginText" onclick="redirectToLogin()">Login</span>
    </div>

    <h1>Pinyin Spelling Practice 拼音听写复习</h1>
    <div id="inputArea">
        <div id="inputBoxContainer">
            <input type="text" id="inputBox" placeholder="输入中文单词 Enter Chinese Phrases" />
        </div>
        <h5>Separate the phrases by comma or spaces 以逗号或空格分隔</h5>
        <button id="startBtn" onclick="toggleSpelling()">Start Spelling 开始听写</button>
    </div>
    <div id="pinyinDisplay"></div>
    <span id="soundIcon" class="material-icons" onclick="playSound()">volume_up</span>

    <div id="navigationButtons">
        <button id="prevBtn" onclick="showPrev()" disabled>Previous 前一个</button>
        <button id="nextBtn" onclick="showNext()" disabled>Next 下一个</button>
    </div>

    <script>
        let chineseWords = [];
        let pinyinWords = [];
        let currentIndex = -1;
        let shownWords = [];
        let currentSoundURL = '';
        let isSpelling = false; // To track spelling session status

        const toneMap = {
            1: { 'a': 'ā', 'e': 'ē', 'i': 'ī', 'o': 'ō', 'u': 'ū', 'ü': 'ǖ' },
            2: { 'a': 'á', 'e': 'é', 'i': 'í', 'o': 'ó', 'u': 'ú', 'ü': 'ǘ' },
            3: { 'a': 'ǎ', 'e': 'ě', 'i': 'ǐ', 'o': 'ǒ', 'u': 'ǔ', 'ü': 'ǚ' },
            4: { 'a': 'à', 'e': 'è', 'i': 'ì', 'o': 'ò', 'u': 'ù', 'ü': 'ǜ' },
        };

        // Function to convert Pinyin with numbers to Pinyin with tones
        function convertToTone(pinyin) {
            const regex = /([aeiouü]+)([1-5])/;
            const match = pinyin.match(regex);

            // If it's tone 5, just remove the number
            if (!match || match[2] === '5') {
                return pinyin.replace(/[1-5]/, ''); // Return without the tone number
            }

            const [_, vowelGroup, tone] = match;
            const toneNumber = parseInt(tone, 10);

            let vowelToReplace = vowelGroup.includes('a') ? 'a'
                : vowelGroup.includes('o') ? 'o'
                : vowelGroup.includes('e') ? 'e'
                : vowelGroup[0]; // First vowel if a, o, e are absent

            const markedVowel = toneMap[toneNumber][vowelToReplace];
            return pinyin.replace(vowelToReplace, markedVowel).replace(/[1-5]/, '');
        }

        // Function to fetch Pinyin from HelloACM API and convert to tones
        async function getPinyinWithTones(word) {
            const response = await fetch(`https://helloacm.com/api/pinyin/?cached&s=${word}&t=1`);
            const data = await response.json();

            if (data.result && data.result.length > 0) {
                const pinyinWithTones = data.result.map(convertToTone);
                return pinyinWithTones.join(" ");
            }
            return null; // Return null if no Pinyin found
        }

        // Fetch the sound URL for the current word
        async function fetchSoundURL(word) {
            const response = await fetch(`https://pinyin-word-api.vercel.app/api/${word}`);
            const data = await response.json();
            return data.url;
        }

        // Play the sound at 0.75x speed
        function playSound() {
            if (currentSoundURL) {
                const audio = new Audio(currentSoundURL);
                audio.playbackRate = 0.75; // Play at 0.75x speed
                audio.play();
            }
        }

        // Start the spelling session
        async function startSpelling() {
            const input = document.getElementById("inputBox").value;

            if (!input) {
                alert("Please enter some Chinese words.");
                return;
            }

            // Replace Chinese commas and multiple spaces with a single space
            const sanitizedInput = input.replace(/，/g, ',').replace(/\s+/g, ' ').trim();

            chineseWords = sanitizedInput.split(/[, ]+/); // Split by comma or space
            pinyinWords = [];
            shownWords = [];
            currentIndex = -1;

            // Fetch Pinyin for all words
            for (const word of chineseWords) {
                const pinyin = await getPinyinWithTones(word);
                if (pinyin) {
                    pinyinWords.push(pinyin);
                } else {
                    console.warn(`No Pinyin found for: ${word}`);
                    pinyinWords.push(word); // Fallback to original word
                }
            }

            document.getElementById("inputBox").style.display = "none";
            document.getElementById("startBtn").textContent = "Stop Spelling";
            document.getElementById("prevBtn").disabled = false;
            document.getElementById("nextBtn").disabled = false;
            isSpelling = true; // Set spelling session status
            showNext();
        }

        // Show the next random word's Pinyin
        async function showNext() {
            if (!isSpelling) return; // Do nothing if not in spelling session

            if (shownWords.length === chineseWords.length) {
                endTest();
                return;
            }

            let randomIndex;
            do {
                randomIndex = Math.floor(Math.random() * chineseWords.length);
            } while (shownWords.includes(randomIndex));

            currentIndex = randomIndex;
            shownWords.push(currentIndex);

            document.getElementById("pinyinDisplay").textContent = pinyinWords[currentIndex];
            document.getElementById("soundIcon").style.display = "block";

            // Pre-fetch the sound for the word
            currentSoundURL = await fetchSoundURL(chineseWords[currentIndex]);
        }

        // Show the previous Pinyin
        function showPrev() {
            if (shownWords.length > 1) {
                shownWords.pop(); // Remove current index
                currentIndex = shownWords[shownWords.length - 1]; // Show the last one
                document.getElementById("pinyinDisplay").textContent = pinyinWords[currentIndex];
                document.getElementById("soundIcon").style.display = "block";
            }
        }

        // Toggle spelling session
        function toggleSpelling() {
            if (isSpelling) {
                endTest();
            } else {
                startSpelling();
            }
        }

        // End the spelling session and show results
function endTest() {
    isSpelling = false;
    document.getElementById("startBtn").textContent = "Start Spelling";
    document.getElementById("inputBox").style.display = "block";
    document.getElementById("pinyinDisplay").textContent = "Please Check Your Answers.";
    document.getElementById("soundIcon").style.display = "none";
    document.getElementById("prevBtn").disabled = true;
    document.getElementById("nextBtn").disabled = true;

    // Show all tested words
    const testedWords = chineseWords.join(", ");
    document.getElementById("pinyinDisplay").innerHTML += `<br/><strong>Words Tested:</strong> ${testedWords}`;
}

        // Redirect to login page
        function redirectToLogin() {
            window.location.href = "/login"; // Update the URL as needed
        }
    </script>
</body>
</html>
