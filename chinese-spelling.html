<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pinyin Spelling Practice</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
        }
        h1 {
            margin-top: 20px;
        }
        #inputBoxContainer {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }
        #inputBox {
            width: 60%;
            padding: 10px;
            font-size: 18px;
            text-align: center;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
        }
        #pinyinDisplay {
            font-size: 32px;
            margin: 20px 0;
            color: #333;
        }
        #navigationButtons {
            margin-top: 20px;
        }
        #soundIcon {
            font-size: 40px;
            cursor: pointer;
            margin-top: 10px;
            color: #007bff; /* Change color as desired */
        }
    </style>
</head>
<body>

    <h1>Chinese Pinyin Spelling Test</h1>
    <div id="inputArea">
        <div id="inputBoxContainer">
            <input type="text" id="inputBox" placeholder="Enter Chinese words separated by commas (e.g., 我们，你们，他们)" />
        </div>
        <button id="startBtn" onclick="startSpelling()">Start Spelling</button>
    </div>

    <div id="pinyinDisplay"></div>
    <span id="soundIcon" class="material-icons" style="display:none;" onclick="playSound()">volume_up</span>

    <div id="navigationButtons">
        <button id="prevBtn" onclick="showPrev()" disabled>Previous</button>
        <button id="nextBtn" onclick="showNext()" disabled>Next</button>
    </div>

    <script>
        let chineseWords = [];
        let pinyinWords = [];
        let currentIndex = -1;
        let shownWords = [];
        let currentSoundURL = '';

        const toneMap = {
            1: { 'a': 'ā', 'e': 'ē', 'i': 'ī', 'o': 'ō', 'u': 'ū', 'ü': 'ǖ' },
            2: { 'a': 'á', 'e': 'é', 'i': 'í', 'o': 'ó', 'u': 'ú', 'ü': 'ǘ' },
            3: { 'a': 'ǎ', 'e': 'ě', 'i': 'ǐ', 'o': 'ǒ', 'u': 'ǔ', 'ü': 'ǚ' },
            4: { 'a': 'à', 'e': 'è', 'i': 'ì', 'o': 'ò', 'u': 'ù', 'ü': 'ǜ' },
        };

        // Function to convert Pinyin with numbers to Pinyin with tones
        function convertToTone(pinyin) {
            const regex = /([aeiouü]+)([1-5])/;
            const match = pinyin.match(regex);

            // If it's tone 5, just remove the number
            if (!match || match[2] === '5') {
                return pinyin.replace(/[1-5]/, ''); // Return without the tone number
            }

            const [_, vowelGroup, tone] = match;
            const toneNumber = parseInt(tone, 10);

            let vowelToReplace = vowelGroup.includes('a') ? 'a'
                : vowelGroup.includes('o') ? 'o'
                : vowelGroup.includes('e') ? 'e'
                : vowelGroup[0]; // First vowel if a, o, e are absent

            const markedVowel = toneMap[toneNumber][vowelToReplace];
            return pinyin.replace(vowelToReplace, markedVowel).replace(/[1-5]/, '');
        }

        // Function to fetch Pinyin from HelloACM API and convert to tones
        async function getPinyinWithTones(word) {
            const response = await fetch(`https://helloacm.com/api/pinyin/?cached&s=${word}&t=1`);
            const data = await response.json();
            const pinyinWithTones = data.result.map(convertToTone);
            return pinyinWithTones.join(" ");
        }

        // Fetch the sound URL for the current word
        async function fetchSoundURL(word) {
            const response = await fetch(`https://pinyin-word-api.vercel.app/api/${word}`);
            const data = await response.json();
            return data.url;
        }

        // Play the sound at 0.75x speed
        function playSound() {
            if (currentSoundURL) {
                const audio = new Audio(currentSoundURL);
                audio.playbackRate = 0.75; // Play at 0.75x speed
                audio.play();
            }
        }

        // Start the spelling session
        async function startSpelling() {
            const input = document.getElementById("inputBox").value;

            if (!input) {
                alert("Please enter some Chinese words.");
                return;
            }

            // Replace Chinese commas with English commas
            const sanitizedInput = input.replace(/，/g, ',');

            chineseWords = sanitizedInput.split(',').map(word => word.trim());
            pinyinWords = [];
            shownWords = [];
            currentIndex = -1;

            // Fetch pinyin for all words
            for (const word of chineseWords) {
                const pinyin = await getPinyinWithTones(word);
                pinyinWords.push(pinyin);
            }

            document.getElementById("inputBox").style.display = "none";
            document.getElementById("startBtn").textContent = "Stop Spelling";
            document.getElementById("prevBtn").disabled = false;
            document.getElementById("nextBtn").disabled = false;
            showNext();
        }

        // Show the next random word's Pinyin
        async function showNext() {
            if (shownWords.length === chineseWords.length) {
                endTest();
                return;
            }

            let randomIndex;
            do {
                randomIndex = Math.floor(Math.random() * chineseWords.length);
            } while (shownWords.includes(randomIndex));

            currentIndex = randomIndex;
            shownWords.push(currentIndex);

            document.getElementById("pinyinDisplay").textContent = pinyinWords[currentIndex];
            document.getElementById("soundIcon").style.display = "block";

            // Pre-fetch the sound for the word
            currentSoundURL = await fetchSoundURL(chineseWords[currentIndex]);
        }

        // Show the previous Pinyin
        function showPrev() {
            if (shownWords.length > 1) {
                shownWords.pop(); // Remove current index
                currentIndex = shownWords[shownWords.length - 1]; // Show the last one
                document.getElementById("pinyinDisplay").textContent = pinyinWords[currentIndex];
                fetchSoundURL(chineseWords[currentIndex]).then(url => {
                    currentSoundURL = url;
                });
            }
        }

        // End the test and reset the input
        function endTest() {
            alert("You've gone through all the words!");
            document.getElementById("inputBox").value = ''; // Clear input box
            document.getElementById("inputBox").style.display = "block";
            document.getElementById("startBtn").textContent = "Start Spelling";
            document.getElementById("prevBtn").disabled = true;
            document.getElementById("nextBtn").disabled = true;
            document.getElementById("pinyinDisplay").textContent = "";
            document.getElementById("soundIcon").style.display = "none";
        }
    </script>

</body>
</html>
